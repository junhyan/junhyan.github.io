<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>OVS源码分析--函数栈 | 这就是个木匣子</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">这就是个木匣子</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">首页</a><a href="/archives" class="sidebar-nav-item">归档</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>OVS源码分析--函数栈</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2017-08-19</div></div></div><article><div class="container post"><p>总结了一些关于OVS源码的函数栈，以便阅读代码和修改代码时候方便查询。主要包括bridge和port相关，tunnel相关，多播相关，forword相关。当前总结还不够全面，之后还会继续更新不断添加。</p>
<h2 id="OVS函数栈"><a href="#OVS函数栈" class="headerlink" title="OVS函数栈"></a>OVS函数栈</h2><h3 id="Bridge相关"><a href="#Bridge相关" class="headerlink" title="Bridge相关"></a>Bridge相关</h3><p>cmd:ovs-vsctl add-br br0<br>main(ovs-vsctl.c)————-<br>ctl_parse_commands:       //parse the commands,<br>ovsdb_idl_create     //initialize the idl, create ovsdb.<br>ovsdb_idl_get_seqno        //‘seqno’ is the database sequence number for which we last tried to     execute our transaction.<br>ovsdb_idl_get_seqno        //get current seqno<br>ovsdb_idl_run      //run ovsdb<br>do_vsctl  ——————-<br>ovsdb_idl_txn_create        //create txn object<br>ovsrec_open_vswitch_first<br>vsctl_context_init        //create command context<br>c→syntax→run    //base on vsctl_commands, callback ‘cmd_add_br’<br>cmd_add_br—————-<br>The main function of this is update the ovsdb base on the ctx.<br>Ovs-vswitchd get the ovsdb change.<br>main(ovs-vswitchd.c)———-<br>bridge_run<br>bridge_reconfigure<br>add_del_bridges<br>bridge_create        //alloc bridge<br>eth_addr_mark_random<br>bridge_delete_ofprotos    //delete invalidate ofprotos<br>ofproto_create            //add ofproto to bridge<br>ofproto_class_find        //class is ofproto_dpif_class<br>class-&gt;construct    //callback  construct in ofproto_dpif_class<br>open_dpif_backer<br>dpif_create_and_open<br>dpif_create<br>dpif_open<br>do_open<br>dp_initialize<br>dp_register_provider    //register dpif_netlink_class and dpif_netdev_class<br>dp_class_lookup    //find registered_class is dpif_netlink_class<br>dpif_class→open     //callback dpif_netlink_open<br>dpif_netlink_dp_init<br>dp_request.cmd = OVS_DP_CMD_NEW<br>dpif_netlink_dp_transact<br>dpif_netlink_dp_to_ofpbuf    //add dp info to ofpbuf<br>nl_transact<br>open_dpif    //create dpif for dp</p>
<p>kernel create dp interface<br>genl_register_family(dp_genl_families[i])         //register genetlink families<br>dp_datapath_genl_ops[] = {<br>{ .cmd = OVS_DP_CMD_NEW,<br>.flags = GENL_UNS_ADMIN_PERM, /<em> Requires CAP_NET_ADMIN privilege. </em>/<br>.policy = datapath_policy,<br>.doit = ovs_dp_cmd_new<br>},<br>ovs_dp_cmd_new<br>ovs_dp_cmd_alloc_info<br>genlmsg_new        //parse genetlink msg<br>ovs_flow_tbl_init        //alloc dp flow table<br>parms.type = OVS_VPORT_TYPE_INTERNAL;<br>parms.port_no = OVSP_LOCAL;<br>parms.upcall_portids = a[OVS_DP_ATTR_UPCALL_PID];<br>new_vport            //ovsbr0<br>ovs_vport_add<br>ovs_vport_lookup (ops  internel)<br>ops→create     callback internal_dev_create (ovs_internal_vport_ops)<br>register_netdevice    //guess it is ovsbr0_sys<br>dev_set_promiscuity        //value 1<br>ovs_dp_cmd_fill_info<br>ovs_notify</p>
<p>Del</p>
<p>port_destroy<br>iface_destroy<br>close_dpif_backer<br>dpif_netlink_rtnl_port_destroy<br>port_del<br>dpif_netlink_port_del<br>dpif→dpif_class→port_del  dpif_netlink_port_del,<br>dpif_port_del<br>ofproto_class→port_del          port_del<br>ofproto_port_del<br>type_run<br>bridge_delete_or_reconfigure_ports<br>bridge_reconfigure</p>
<h3 id="Port相关"><a href="#Port相关" class="headerlink" title="Port相关"></a>Port相关</h3><p>As same as bridge created in most  process.<br>main(Ovs-vsctl.c) will use cmd_add_port<br>add_port()<br>insert port information to the ovsdb<br>bridge_reconfigure<br>add_del_bridges<br>bridge_delete_ofprotos<br>ofproto_create<br>bridge_add_ports<br>bridge_add_ports<br>iface_create<br>iface_do_create<br>ofproto_port_add<br>ofproto→ofproto_class→port_add        //class is ofproto_dpif_class    callback port_add<br>dpif_port_add<br>dpif→dpif_class→port_add         //callback dpif_netlink_class→dpif_netlink_port_add<br>dpif_netlink_port_add_compat<br>dpif_netlink_port_add       // with arg struct ofpbuf *options =NULL<br>request.cmd = OVS_VPORT_CMD_NEW<br>request.type = OVS_VPORT_TYPE_NETDEV<br>dpif_netlink_vport_transact<br>dpif_netlink_vport_to_ofpbuf<br>nl_transact<br>port_create</p>
<p>kernel dp add port netdev<br>dp_vport_genl_family    //(S)<br>dp_vport_genl_ops        //(S)<br>{ .cmd = OVS_VPORT_CMD_NEW,<br>  .flags = GENL_UNS_ADMIN_PERM, /<em> Requires CAP_NET_ADMIN privilege. </em>/<br>  .policy = vport_policy,<br>  .doit = ovs_vport_cmd_new<br>},<br>ovs_vport_cmd_new<br>get_dp<br>ovs_vport_ovsl     //verify portno<br>new_vport<br>ovs_vport_add<br>ovs_vport_lookup</p>
<h3 id="Tunnel相关"><a href="#Tunnel相关" class="headerlink" title="Tunnel相关"></a>Tunnel相关</h3><p>2.8<br>dpif_netlink_port_add:<br>dpif_netlink_rtnl_port_create_and_add<br>dpif_netlink_rtnl_port_create<br>netdev_get_tunnel_config<br>get_netdev_tunnel_config<br>dpif_netlink_rtnl_create</p>
<h3 id="多播相关"><a href="#多播相关" class="headerlink" title="多播相关"></a>多播相关</h3><p>multicast: (action=normal)<br>do_xlate_actions<br>xlate_output_action<br>xlate_normal<br>is_igmp<br>mcast_snooping_is_membership<br>xlate_normal_mcast_send_mrouters        //send pkts to all ports that connect with the multicast router.<br>xlate_normal_mcast_send_rports<br>xlate_normal_flood</p>
<h3 id="Forword相关"><a href="#Forword相关" class="headerlink" title="Forword相关"></a>Forword相关</h3><p>UserSpase:<br>创建udpif_upcall_handler流程：<br>Main（ovs-vswitchd.c）—&gt; bridge_run —&gt; bridge_reconfigure —&gt; ofproto_create—&gt;construct —&gt; open_dpif_backer —&gt;udpif_create—&gt;udpif_set_threads—&gt;udpif_start_threads—&gt; udpif_upcall_handler</p>
<p>udpif_upcall_handler接收upcall流程：</p>
<p>udpif_upcall_handler —&gt; recv_upcalls—&gt; process_upcall —&gt; upcall_xlate —&gt; xlate_actions -</p>
<p>rule_dpif_lookup_from_table<br>–&gt; do_xlate_actions—&gt; handle_upcalls</p>
<p>kernel:<br>简单的提供一些函数，具体实现可以看ovs源码。<br>netdev_create<br>ovs_netdev_link<br>netdev_port_receive<br>ovs_vport_receive<br>ovs_dp_process_packet<br>ovs_flow_tbl_lookup_stats<br>ovs_flow_key_extract<br>flow_lookup<br>两种查询方式具体可以看源码。<br>upcall<br>ovs_execute_actions</p>
<p>转载请注明: <a href="http://jhyan.me/2017/08/19/OVS源码函数栈/" target="_blank" rel="noopener">http://jhyan.me/2017/08/19/OVS源码函数栈/</a></p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:yanjunhan@163.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/junhyan" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">woodenbox</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>