<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Ecui框架在兼容Pointer事件过程中踩过的坑 | 这就是个木匣子</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">这就是个木匣子</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">首页</a><a href="/archives" class="sidebar-nav-item">归档</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Ecui框架在兼容Pointer事件过程中踩过的坑</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2018-06-09</div></div></div><article><div class="container post"><p>最近组内在总结Ecui事件集中管理的一下思想和处理方式，在总结过程中我们对Ecui框架进行了拓展，增加了Ecui框架对Pointer事件的支持。在开发过程中踩了关于pointermove和pointercancel的两个坑。所以写下这篇文字记录下踩得坑和解决方案。</p>
<h2 id="Pointer事件简介"><a href="#Pointer事件简介" class="headerlink" title="Pointer事件简介"></a>Pointer事件简介</h2><p>当前的web应用的Pointing设备除了鼠标还有触屏和电子笔，Pointer事件是一系列为pionting设备制定的DOM事件，现在在开发过程中针对于不同的设备有Touch事件有mouse事件，有的设备既支持touch又支持mouse，所以设计Pointer事件的主要目的是做一个标准的事件处理方式，可以兼顾mouse、touch和pen事件。Pointer事件是硬件无关的，对大多数的屏幕都支持。因为本篇不是对Pointer事件的介绍所以更加具体的内容可以参照<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Pointer_events" target="_blank" rel="noopener">MDN Pointer事件</a>。<br>下面就说下在兼容Pointer事件过程中遇到的坑。</p>
<h2 id="兼容Pointer事件遇到的坑"><a href="#兼容Pointer事件遇到的坑" class="headerlink" title="兼容Pointer事件遇到的坑"></a>兼容Pointer事件遇到的坑</h2><p>此次踩到的坑一个是在触屏的情况下drag或者move或者长按的时候，point会触发pointercancel事件，导致之后的pointer事件都失效；另一个是在开发过程中监管了原生的点击事件，比如使用了Ecui或者fastclick库，并且对Pointer事件的处理如果与Touch类似的时候在surface pro上触发的坑。</p>
<h3 id="pointercancel引起的坑"><a href="#pointercancel引起的坑" class="headerlink" title="pointercancel引起的坑"></a>pointercancel引起的坑</h3><p>在我们对Ecui框架做Pointer事件的兼容过程中，发现在支持Touch事件和Pointer事件的浏览器和设备上，当触摸时间久一点，Pointer事件处理函数就不会被触发。究其原因发现使用Pointer事件的应用程序将在浏览器开始处理Touch手势时会收到一个pointercancel事件。<br>问题的解决方案是当触控事件发生在元素上时，不进行任何操作，即用到了css3的属性touch-action，将该属性设置为none，具体设置代码如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.listview</span> * &#123;</span><br><span class="line">    <span class="attribute">touch-action</span>:none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就可以使listview class所在元素全面支持pointer事件，此处在类名后添加‘*’是因为touch-action不是继承属性，添加‘*’是元素内部所有元素都可以支持pointer事件处理。</p>
<h3 id="pointermove引起的坑"><a href="#pointermove引起的坑" class="headerlink" title="pointermove引起的坑"></a>pointermove引起的坑</h3><p>踩到这个坑的主要的原因是对于同时兼容mouse与touch的设备，mouse相关事件无法确定是由touch行为产生的还是mouse行为产生的，所以需要pointer来统一二者的行为。在move事件触发的时候，是不容许有点击事件发生的，所以在触发move事件后就会禁止到点击事件，当然，点击事件也需要是框架或者事件库（如fastclick）对点击事件进行拦截和处理。fastclick在Vue项目中广为使用，但因为目前还没有对Pionter事件的拦截集中处理。此处可以看下fastclick对于touchmove事件的处理：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FastClick.prototype.onTouchMove = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.trackingClick) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If the touch has moved, cancel the click tracking</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.targetElement !== <span class="keyword">this</span>.getTargetElementFromEventTarget(event.target) || <span class="keyword">this</span>.touchHasMoved(event)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.trackingClick = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.targetElement = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看出fastclick对于touchmove事件的拦截处理过程中，如果判断是move的状态，则禁止了点击事件，targetElement设置为了null；targetElement是点击事件的目标元素，在fastclick中的定义和说明如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The element being tracked for a click.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @type EventTarget</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">this</span>.targetElement = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure></p>
<p>发现的问题是如果设备既支持鼠标事件又支持触屏事件，Pointer设备上纯点击也可能会触发move，比如surface pro设备，添加了对pointmove的拦截处理后，就不会触发点击事件了，至少使用人的手指很难触发。原因在于pointer事件在于当手指按在触屏上时候，手指与屏幕接触面积会逐渐变大，从而被当成了pointermove事件，因此也不会触发click事件了。<br>问题在Ecui中的解决方案是：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pointer设备上纯点击也可能会触发move</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="built_in">Math</span>.sqrt(track.speedX * track.speedX + track.speedY * track.speedY) &gt; HIGH_SPEED) &amp;&amp; isMobileMoved === <span class="literal">false</span>) &#123;</span><br><span class="line">    isMobileMoved = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此处做的判断是如果左右滑动和上下滑动的向量速度大于HIGH_SPEED（100)才算做是pointermove事件，对于速度的计算Ecui是通过pageX/pageY，和触发时间与当前时间来计算。这样在速度足够低的情况下就可以认为是点击事件。</p>
<h3 id="pointer-event穿透实现"><a href="#pointer-event穿透实现" class="headerlink" title="pointer-event穿透实现"></a>pointer-event穿透实现</h3><p>穿透的实现跟pointer没关系，ie10以前是都不支持Pointer事件的，这部分内容是对事件的拓展。<br>在很多的B端项目中会需要用到穿透的效果来实现对下层元素事件的触发。比如公司组织结构节点移动，移动后下方元素的重新组合。<br>pointer-event是css3属性，设置pointer-events: none可以禁止设置元素的鼠标和触屏事件，这样就可以实现穿透效果。该属性在大部分IE之外的浏览器都支持，IE10以上（不包括IE10）也支持，但是对于低版本的IE该属性不支持，Ecui对低版本的IE做了特殊处理：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (ieVersion &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> name = ieVersion &lt; <span class="number">9</span> ? <span class="string">'filter'</span> : <span class="string">'content'</span>;</span><br><span class="line">outer:          <span class="keyword">for</span> (<span class="keyword">var</span> caches = [], target = event.target, el; target; target = getElementFromEvent(event)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (el = target;; el = dom.getParent(el)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!el) &#123;</span><br><span class="line">                            <span class="keyword">break</span> outer;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">var</span> text = el.currentStyle[name];</span><br><span class="line">                        <span class="keyword">if</span> (text &amp;&amp; text.indexOf(<span class="string">'pointer-events:none'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            caches.push([el, el.style.visibility]);</span><br><span class="line">                            el.style.visibility = <span class="string">'hidden'</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.target = target;</span><br><span class="line">                caches.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">                    item[<span class="number">0</span>].style.visibility = item[<span class="number">1</span>];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过在设置元素的css属性来实现，对于小于IE9的版本设置filter属性，对于IE9和IE10的版本设置content属性，设置属性为pointer-events:none，并通过该属性来获得元素对象，通过设置visibility属性来暂时隐藏元素，从而实现穿透效果，触发穿透后的事件后，再显示出该元素。<br>选择filter和content是因为在IE6-IE8版本中filter中的无效滤镜不会工作，但值会被保留；在IE9-IE10版本中content需要配合::before和::after伪类才有意义，直接给element设置没有任何意义。而如果直接写IE不支持的css属性则会被IE浏览器忽略，通过filter和content变相实现了元素对象的获取。<br>在此处再介绍一个与文章主题关系不大的css的坑，也是在开发中发现的，height与line-height相等的情况下，部分PC浏览器可能盒子模型下的高度会是小数，我们的解决方案是建议line-height的取值比height小1。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Pointer事件有很多的实用属性，可以检测手指按下的倾斜程度，可以检测手指的按压力度等。在Ecui拓展支持Pointer事件的过程中踩到了pointercancel和pointermove的两个坑，并且找到了问题的根源，解决了问题，实现了对Pointer事件的集中管理，也实现了穿透的效果。</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:yanjunhan@163.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/junhyan" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">woodenbox</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>